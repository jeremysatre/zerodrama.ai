<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SNKPBL0P7Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-SNKPBL0P7Q');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Navigation Tool | ZeroDrama.ai</title>
    <meta name="description" content="AI-powered change navigation assistant. Get instant diagnosis and actionable plans for your organizational change challenges.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #1a2b4a;
            --navy-dark: #0f1a2e;
            --steel-blue: #5889A8;
            --lime: #B8D84F;
            --lime-hover: #c9e860;
            --coral: #FF9A6C;
            --coral-hover: #ffab82;
            --off-white: #fafafa;
            --light-gray: #f0f2f5;
            --text-primary: #1a2b4a;
            --text-secondary: #5a6a7a;
            --glass-bg: rgba(26, 43, 74, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy) 50%, var(--navy-dark) 100%);
            color: white;
            line-height: 1.7;
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 2rem;
            background: rgba(15, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 500;
            color: white;
            text-decoration: none;
        }

        .nav-logo span {
            color: var(--lime);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--lime);
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 7rem 2rem 4rem;
        }

        /* Header */
        .tool-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .tool-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 4vw, 2.75rem);
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .tool-header h1 span {
            color: var(--lime);
        }

        .tool-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Entry Mode Selection */
        .mode-selection {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .mode-card {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.75rem 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--lime);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mode-card:hover {
            border-color: var(--lime);
            transform: translateX(8px);
        }

        .mode-card:hover::before {
            opacity: 1;
        }

        .mode-card.selected {
            border-color: var(--lime);
            background: rgba(184, 216, 79, 0.1);
        }

        .mode-card.selected::before {
            opacity: 1;
        }

        .mode-icon {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .mode-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: white;
        }

        .mode-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-style: italic;
        }

        /* Intake Form */
        .intake-form {
            display: none;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2.5rem;
            backdrop-filter: blur(10px);
            animation: slideIn 0.4s ease-out;
        }

        .intake-form.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-progress {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: var(--lime);
            width: 30px;
            border-radius: 5px;
        }

        .progress-dot.completed {
            background: var(--lime);
        }

        .question-container {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .question-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question-number {
            font-size: 0.85rem;
            color: var(--lime);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .question-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        /* Form Controls */
        .option-grid {
            display: grid;
            gap: 0.75rem;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            color: white;
            font-size: 0.95rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .option-btn.selected {
            background: rgba(184, 216, 79, 0.2);
            border-color: var(--lime);
        }

        .option-btn.multi-select.selected::after {
            content: ' ‚úì';
            color: var(--lime);
            font-weight: bold;
        }

        textarea.text-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.3s ease;
            min-height: 120px;
        }

        textarea.text-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        textarea.text-input:focus {
            border-color: var(--lime);
        }

        /* Navigation Buttons */
        .form-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--glass-border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .btn-back {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--glass-border);
        }

        .btn-back:hover {
            border-color: white;
            color: white;
        }

        .btn-next {
            background: var(--lime);
            color: var(--navy);
        }

        .btn-next:hover {
            background: var(--lime-hover);
            transform: translateY(-2px);
        }

        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--coral), #FF7E4A) !important;
            color: var(--navy);
            padding: 1rem 2.5rem;
            font-size: 1rem;
        }

        .btn-submit:hover {
            background: linear-gradient(135deg, var(--coral-hover), var(--coral)) !important;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 154, 108, 0.3);
        }

        /* Results Section */
        .results-container {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .results-container.active {
            display: block;
        }

        .results-header {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .results-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .results-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .results-section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--lime), #9bc23c);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .results-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .results-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.8;
        }

        .results-content p {
            margin-bottom: 1rem;
        }

        .results-content ul {
            list-style: none;
            padding: 0;
        }

        .results-content li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .results-content li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--lime);
        }

        /* Chat Refinement */
        .chat-refinement {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .chat-refinement h4 {
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-refinement h4::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--lime);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
        }

        .chat-message {
            padding: 0.875rem 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .chat-message.user {
            background: var(--lime);
            color: var(--navy);
            margin-left: 20%;
        }

        .chat-message.bot {
            background: rgba(88, 137, 168, 0.3);
            margin-right: 20%;
        }

        .chat-input-area {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
        }

        .chat-input-area input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .chat-input-area input:focus {
            border-color: var(--lime);
        }

        .chat-send-btn {
            width: 48px;
            height: 48px;
            background: var(--lime);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: var(--lime-hover);
            transform: scale(1.05);
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--navy);
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 26, 46, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1.5rem;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--lime);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Error message */
        .error-details {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: #ff9999;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .container {
                padding: 6rem 1.25rem 3rem;
            }

            .intake-form {
                padding: 1.5rem;
            }

            .mode-card {
                padding: 1.25rem 1.5rem;
            }

            .question-text {
                font-size: 1.25rem;
            }

            .form-nav {
                flex-direction: column;
                gap: 1rem;
            }

            .form-nav .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="/" class="nav-logo">Zero<span>Drama</span>.ai</a>
            <ul class="nav-links">
                <li><a href="/#about">About</a></li>
                <li><a href="/#services">Services</a></li>
                <li><a href="/#contact">Contact</a></li>
            </ul>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Analyzing your situation...</div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="tool-header">
            <h1>Change <span>Navigation</span> Assistant</h1>
            <p>Get clear, actionable guidance for your organizational change challenge. No theory ‚Äî just what to do next.</p>
        </div>

        <!-- Step 1: Entry Mode Selection -->
        <div id="mode-step">
            <div class="mode-selection">
                <div class="mode-card" data-mode="conversation">
                    <div class="mode-icon">üéØ</div>
                    <div class="mode-title">A Critical Conversation is Coming</div>
                    <div class="mode-description">"I need to talk to someone about this change and I don't want it to blow up."</div>
                </div>

                <div class="mode-card" data-mode="stalled">
                    <div class="mode-icon">üîç</div>
                    <div class="mode-title">This Initiative is Stalling</div>
                    <div class="mode-description">"We're stuck, and everyone has a different explanation."</div>
                </div>

                <div class="mode-card" data-mode="middle">
                    <div class="mode-icon">‚öñÔ∏è</div>
                    <div class="mode-title">I'm Caught in the Middle</div>
                    <div class="mode-description">"Leadership expects results, my team is struggling, and I'm stuck between them."</div>
                </div>
            </div>
        </div>

        <!-- Step 2: Intake Form -->
        <div class="intake-form" id="intake-form">
            <div class="form-progress" id="progress-dots">
                <!-- Dots generated by JS -->
            </div>

            <!-- Questions Container -->
            <div id="questions-container">
                <!-- Questions generated by JS based on mode -->
            </div>

            <div class="form-nav">
                <button class="btn btn-back" id="btn-back">‚Üê Back</button>
                <button class="btn btn-next" id="btn-next">Continue ‚Üí</button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="results-container" id="results">
            <div class="results-header">
                <h2>Your Action Plan</h2>
                <p>Based on your inputs, here's what to do next.</p>
            </div>

            <div id="results-content">
                <!-- Filled by API response -->
            </div>

            <!-- Chat Refinement -->
            <div class="chat-refinement">
                <h4>Need clarification or want to go deeper?</h4>
                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages appear here -->
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Ask a follow-up question...">
                    <button class="chat-send-btn" id="chat-send-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-back" id="btn-start-over">‚Üê Start New Assessment</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentMode = null;
        let currentQuestionIndex = 0;
        let answers = {};
        let conversationHistory = [];

        // ============================================
        // QUESTION DEFINITIONS BY MODE
        // ============================================
        const questionSets = {
            conversation: [
                {
                    id: 'who',
                    question: 'Who is this conversation with?',
                    subtext: 'Power dynamics shape everything about how to approach this.',
                    type: 'multi-select',
                    options: [
                        'Direct report',
                        'Peer or colleague',
                        'Manager or leadership',
                        'Executive sponsor',
                        'Cross-functional team',
                        'External stakeholder'
                    ]
                },
                {
                    id: 'change_type',
                    question: 'What is the change about?',
                    subtext: 'Different changes trigger different types of resistance.',
                    type: 'single-select',
                    options: [
                        'New technology or system',
                        'Process or workflow change',
                        'Role or responsibility shift',
                        'Organizational restructure',
                        'Strategy or priority shift',
                        'Something else'
                    ]
                },
                {
                    id: 'resistance',
                    question: 'What resistance are you seeing or expecting?',
                    subtext: 'Identifying the pattern helps determine the approach.',
                    type: 'multi-select',
                    options: [
                        'Open pushback or vocal opposition',
                        'Passive compliance (sure, whatever)',
                        'Silence or avoidance',
                        'Emotional reactions',
                        'They say yes but act no',
                        'Not sure yet'
                    ]
                },
                {
                    id: 'internal_state',
                    question: 'Be honest - what is hardest for YOU about this?',
                    subtext: 'Separating your friction from theirs is critical.',
                    type: 'multi-select',
                    options: [
                        'I do not want conflict',
                        'I am frustrated or irritated',
                        'I am unsure of my authority',
                        'I feel caught in the middle',
                        'I do not fully agree with the change',
                        'I am emotionally drained'
                    ]
                },
                {
                    id: 'authority',
                    question: 'What is your actual authority here?',
                    subtext: 'This prevents over-promising what you can deliver.',
                    type: 'single-select',
                    options: [
                        'I can decide this',
                        'I can influence but not decide',
                        'I am delivering someone elses decision',
                        'I honestly do not know'
                    ]
                },
                {
                    id: 'timing',
                    question: 'When is this conversation happening?',
                    subtext: 'This calibrates depth vs. speed of guidance.',
                    type: 'single-select',
                    options: [
                        'Today',
                        'This week',
                        'Soon, but not scheduled',
                        'I have been avoiding it'
                    ]
                },
                {
                    id: 'stakes',
                    question: 'What is at risk if this goes poorly?',
                    subtext: 'Understanding stakes helps prioritize what matters.',
                    type: 'multi-select',
                    options: [
                        'Loss of trust or relationship damage',
                        'Delay or failure of the initiative',
                        'Escalation to leadership',
                        'Team disengagement',
                        'My personal credibility',
                        'Other'
                    ]
                },
                {
                    id: 'outcome',
                    question: 'What would success look like after this conversation?',
                    subtext: 'Be specific - this anchors the whole plan.',
                    type: 'text',
                    placeholder: 'e.g., "They agree to pilot the new process with their team" or "We have clarity on next steps even if they disagree"'
                }
            ],
            stalled: [
                {
                    id: 'initiative',
                    question: 'What change initiative are you working on?',
                    subtext: 'Give us context on what you are trying to accomplish.',
                    type: 'text',
                    placeholder: 'e.g., Rolling out new CRM, process redesign, org restructure'
                },
                {
                    id: 'timeline',
                    question: 'How long has this initiative been running?',
                    subtext: 'Timing affects diagnosis.',
                    type: 'single-select',
                    options: [
                        'Still in planning (not launched)',
                        '1-4 weeks',
                        '1-3 months',
                        '3-6 months',
                        '6+ months'
                    ]
                },
                {
                    id: 'adoption',
                    question: 'What is the current adoption or engagement level?',
                    subtext: 'Where are people actually at?',
                    type: 'single-select',
                    options: [
                        'Not launched yet',
                        '0-25% - Most are not using it',
                        '26-50% - Some adoption, lots of gaps',
                        '51-75% - Decent but inconsistent',
                        '76-100% - Strong adoption'
                    ]
                },
                {
                    id: 'symptoms',
                    question: 'What symptoms are you seeing?',
                    subtext: 'Check all that apply.',
                    type: 'multi-select',
                    options: [
                        'Missed milestones or timeline slipping',
                        'People say yes but do not follow through',
                        'Blame-shifting between teams',
                        'Quiet disengagement or people checking out',
                        'Leadership losing patience',
                        'Confusion about who owns what',
                        'Training done but not applied'
                    ]
                },
                {
                    id: 'root_cause_guess',
                    question: 'What do YOU think is the root cause?',
                    subtext: 'Your instinct matters - we will validate or challenge it.',
                    type: 'single-select',
                    options: [
                        'Active resistance from key people',
                        'Poor design - the change itself has problems',
                        'Misalignment - different goals or priorities',
                        'Change saturation - too many changes at once',
                        'Unclear ownership or accountability',
                        'Leadership is not really behind it',
                        'I do not know'
                    ]
                },
                {
                    id: 'tried',
                    question: 'What have you already tried?',
                    subtext: 'So we do not suggest things you have done.',
                    type: 'multi-select',
                    options: [
                        'More training',
                        'More communication or emails',
                        'Leadership town hall',
                        '1:1 conversations with resisters',
                        'Incentives or consequences',
                        'Project timeline adjustments',
                        'Nothing significant yet'
                    ]
                },
                {
                    id: 'authority_stalled',
                    question: 'What can you actually control here?',
                    subtext: 'This shapes realistic recommendations.',
                    type: 'single-select',
                    options: [
                        'I own this initiative end-to-end',
                        'I influence but do not control key decisions',
                        'I am executing someone elses plan',
                        'It is unclear'
                    ]
                },
                {
                    id: 'unblock_goal',
                    question: 'What would unstuck look like in the next 30 days?',
                    subtext: 'Be realistic about near-term progress.',
                    type: 'text',
                    placeholder: 'e.g., "Key team starts using the new system daily" or "We identify and address the real blockers"'
                }
            ],
            middle: [
                {
                    id: 'situation',
                    question: 'Describe your situation in a few sentences.',
                    subtext: 'What is the change, and where are you stuck between parties?',
                    type: 'text',
                    placeholder: 'e.g., "Leadership wants faster rollout, my team says they need more time, and I am supposed to make both happy."'
                },
                {
                    id: 'upward_pressure',
                    question: 'What is leadership expecting from you?',
                    subtext: 'What is the explicit or implicit demand?',
                    type: 'multi-select',
                    options: [
                        'Faster results or timeline pressure',
                        'Higher adoption numbers',
                        'Less noise or fewer complaints',
                        'Me to handle it or make problems go away',
                        'Visible progress reports',
                        'Not clear - mixed messages'
                    ]
                },
                {
                    id: 'downward_reality',
                    question: 'What is your team actually experiencing?',
                    subtext: 'What are they telling you (or not telling you)?',
                    type: 'multi-select',
                    options: [
                        'Overwhelmed - too many changes at once',
                        'Do not understand why this matters',
                        'Have not been given time to adjust',
                        'The change does not work for them',
                        'They are complying but resentful',
                        'Afraid to speak up',
                        'Actually doing fine - leadership does not see it'
                    ]
                },
                {
                    id: 'your_position',
                    question: 'How are you feeling in this role?',
                    subtext: 'Be honest - this matters.',
                    type: 'multi-select',
                    options: [
                        'Exhausted from translating between both sides',
                        'Frustrated - I agree with my team but cannot say it',
                        'Pressured to sugarcoat reality upward',
                        'Unclear on what I am actually supposed to do',
                        'Worried about my own credibility',
                        'Actually okay - I just need tactics'
                    ]
                },
                {
                    id: 'authority_middle',
                    question: 'What can you actually control?',
                    subtext: 'Realistic boundaries help.',
                    type: 'single-select',
                    options: [
                        'I can push back on leadership timeline or demands',
                        'I can advocate but rarely win',
                        'I can only control how I communicate',
                        'I have no real leverage on either side'
                    ]
                },
                {
                    id: 'support',
                    question: 'Who else could help carry this?',
                    subtext: 'You do not have to do this alone.',
                    type: 'multi-select',
                    options: [
                        'A peer in a similar position',
                        'My own manager',
                        'HR or Change Management team',
                        'An executive champion',
                        'No one - I am isolated',
                        'I have not asked anyone yet'
                    ]
                },
                {
                    id: 'clarity_goal',
                    question: 'What would help you most right now?',
                    subtext: 'What outcome are you looking for from this tool?',
                    type: 'single-select',
                    options: [
                        'Language for a conversation with leadership',
                        'Language for a conversation with my team',
                        'Help clarifying what is actually my job',
                        'A way to protect my own wellbeing',
                        'A plan to make real progress',
                        'All of the above'
                    ]
                }
            ]
        };

        // ============================================
        // EVENT LISTENERS - Using Event Delegation
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Mode card selection
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectMode(this.dataset.mode);
                });
            });

            // Navigation buttons
            document.getElementById('btn-back').addEventListener('click', previousQuestion);
            document.getElementById('btn-next').addEventListener('click', nextQuestion);
            document.getElementById('btn-start-over').addEventListener('click', startOver);

            // Chat
            document.getElementById('chat-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
            document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
        });

        // ============================================
        // MODE SELECTION
        // ============================================
        function selectMode(mode) {
            // Update UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');

            // Set state
            currentMode = mode;
            currentQuestionIndex = 0;
            answers = { mode: mode };

            // Wait a moment then show form
            setTimeout(() => {
                document.getElementById('mode-step').style.display = 'none';
                document.getElementById('intake-form').classList.add('active');
                buildQuestions();
                showQuestion(0);
            }, 300);
        }

        // ============================================
        // FORM BUILDING
        // ============================================
        function buildQuestions() {
            const questions = questionSets[currentMode];
            const container = document.getElementById('questions-container');
            const progressContainer = document.getElementById('progress-dots');

            // Build progress dots
            progressContainer.innerHTML = questions.map((_, i) => 
                `<div class="progress-dot" data-index="${i}"></div>`
            ).join('');

            // Build questions
            container.innerHTML = questions.map((q, i) => {
                let inputHTML = '';

                if (q.type === 'single-select' || q.type === 'multi-select') {
                    const isMulti = q.type === 'multi-select';
                    inputHTML = `<div class="option-grid">
                        ${q.options.map((opt, optIndex) => 
                            `<button type="button" class="option-btn ${isMulti ? 'multi-select' : ''}" 
                                data-question="${q.id}" 
                                data-value="${optIndex}"
                                data-multi="${isMulti}">${opt}</button>`
                        ).join('')}
                    </div>`;
                } else if (q.type === 'text') {
                    inputHTML = `<textarea class="text-input" data-question="${q.id}" placeholder="${q.placeholder || ''}"></textarea>`;
                }

                return `
                    <div class="question-container" data-index="${i}">
                        <div class="question-number">Question ${i + 1} of ${questions.length}</div>
                        <div class="question-text">${q.question}</div>
                        <div class="question-subtext">${q.subtext}</div>
                        ${inputHTML}
                    </div>
                `;
            }).join('');

            // Add event listeners for options
            container.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    handleOptionClick(this);
                });
            });

            // Add event listeners for textareas
            container.querySelectorAll('.text-input').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const questionId = this.dataset.question;
                    answers[questionId] = this.value;
                    updateNextButtonState();
                });
            });
        }

        function handleOptionClick(btn) {
            const questionId = btn.dataset.question;
            const valueIndex = parseInt(btn.dataset.value);
            const isMulti = btn.dataset.multi === 'true';
            const questions = questionSets[currentMode];
            const question = questions.find(q => q.id === questionId);
            const actualValue = question.options[valueIndex];

            if (isMulti) {
                btn.classList.toggle('selected');
                if (!answers[questionId]) answers[questionId] = [];
                
                if (btn.classList.contains('selected')) {
                    answers[questionId].push(actualValue);
                } else {
                    answers[questionId] = answers[questionId].filter(v => v !== actualValue);
                }
            } else {
                // Single select - clear others
                document.querySelectorAll(`[data-question="${questionId}"]`).forEach(b => {
                    b.classList.remove('selected');
                });
                btn.classList.add('selected');
                answers[questionId] = actualValue;
            }
            updateNextButtonState();
        }

        function showQuestion(index) {
            const questions = questionSets[currentMode];
            
            // Hide all questions
            document.querySelectorAll('.question-container').forEach(q => {
                q.classList.remove('active');
            });

            // Show current question
            document.querySelector(`.question-container[data-index="${index}"]`).classList.add('active');

            // Update progress dots
            document.querySelectorAll('.progress-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < index) dot.classList.add('completed');
                if (i === index) dot.classList.add('active');
            });

            // Update navigation buttons
            const backBtn = document.getElementById('btn-back');
            const nextBtn = document.getElementById('btn-next');

            backBtn.style.visibility = index === 0 ? 'hidden' : 'visible';

            if (index === questions.length - 1) {
                nextBtn.textContent = 'Get My Action Plan ‚Üí';
                nextBtn.classList.add('btn-submit');
            } else {
                nextBtn.textContent = 'Continue ‚Üí';
                nextBtn.classList.remove('btn-submit');
            }

            currentQuestionIndex = index;
            updateNextButtonState();
        }

        function updateNextButtonState() {
            const questions = questionSets[currentMode];
            const currentQ = questions[currentQuestionIndex];
            const answer = answers[currentQ.id];

            const hasAnswer = answer && (
                (typeof answer === 'string' && answer.trim().length > 0) ||
                (Array.isArray(answer) && answer.length > 0)
            );

            document.getElementById('btn-next').disabled = !hasAnswer;
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function nextQuestion() {
            const questions = questionSets[currentMode];
            
            if (currentQuestionIndex < questions.length - 1) {
                showQuestion(currentQuestionIndex + 1);
            } else {
                submitAssessment();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                showQuestion(currentQuestionIndex - 1);
            } else {
                // Go back to mode selection
                document.getElementById('intake-form').classList.remove('active');
                document.getElementById('mode-step').style.display = 'block';
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                currentMode = null;
                answers = {};
            }
        }

        function startOver() {
            document.getElementById('results').classList.remove('active');
            document.getElementById('mode-step').style.display = 'block';
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            currentMode = null;
            currentQuestionIndex = 0;
            answers = {};
            conversationHistory = [];
            document.getElementById('chat-messages').innerHTML = '';
        }

        // ============================================
        // API SUBMISSION
        // ============================================
        async function submitAssessment() {
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                const response = await callClaudeAPI(buildInitialPrompt());
                
                loading.classList.remove('active');
                document.getElementById('intake-form').classList.remove('active');
                
                displayResults(response);
                document.getElementById('results').classList.add('active');

            } catch (error) {
                loading.classList.remove('active');
                console.error('API Error:', error);
                alert('Sorry, there was an error processing your request. Please try again.\n\nError: ' + error.message);
            }
        }

        function buildInitialPrompt() {
            const modeDescriptions = {
                conversation: 'A Critical Conversation is Coming',
                stalled: 'This Initiative is Stalling',
                middle: 'I am Caught in the Middle'
            };

            let prompt = `Entry Mode: ${modeDescriptions[currentMode]}\n\n`;
            prompt += 'User Inputs:\n';

            const questions = questionSets[currentMode];
            questions.forEach(q => {
                const answer = answers[q.id];
                if (answer) {
                    const answerStr = Array.isArray(answer) ? answer.join(', ') : answer;
                    prompt += `- ${q.question}: ${answerStr}\n`;
                }
            });

            prompt += '\nBased on these inputs, provide a comprehensive action plan.';

            return prompt;
        }

        async function callClaudeAPI(userMessage) {
            const systemPrompt = `You are the ZeroDrama.ai Change Navigation Assistant ‚Äî a tactical advisor for leaders navigating organizational transformation.

DESIGN CRITERIA ‚Äî EVERY RESPONSE MUST:
1. Address something PAINFUL RIGHT NOW (not theoretical)
2. Acknowledge REAL CONSEQUENCES if mishandled
3. End with CLEAR ACTION, not just reflection
4. Be relevant to organizational transformation contexts

RESPONSE FORMAT:
Structure your response with these exact sections (use these headers):

## üîç What's Really Happening
[Diagnosis of the root issue based on their inputs. Distinguish between: resistance, misalignment, poor design, change saturation, or unclear authority. Be specific and direct.]

## üéØ How to Frame This
[The strategic approach. What lens to use. What to acknowledge upfront. How to position yourself.]

## üí¨ Language to Use (and Avoid)
[Specific phrases, scripts, or talking points. What NOT to say. Give them actual words they can use.]

## ‚û°Ô∏è Your Next 3 Steps
[Concrete, sequenced actions. What to do first, second, third. Be specific about timing.]

## ‚ö†Ô∏è Watch Out For
[Red flags, common mistakes, likely reactions to prepare for.]

OPERATING PRINCIPLES:
- NEVER assume the user has full decision authority ‚Äî most don't
- ALWAYS consider power dynamics and role constraints
- Distinguish between resistance, poor design, misalignment, overload, and unclear authority
- Don't over-validate emotions without redirecting to clarity
- Be direct and practical, not academic

TONE: Calm. Grounded. Direct. Respectful. Practical.`;

            conversationHistory.push({ role: 'user', content: userMessage });

            const requestBody = {
                model: 'claude-3-haiku-20240307',
                max_tokens: 2048,
                system: systemPrompt,
                messages: conversationHistory
            };

            console.log('Sending request to API...');

            const response = await fetch('https://zerodrama-api.jeremysatre.workers.dev/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            console.log('Response status:', response.status);

            const data = await response.json();
            console.log('Response data:', data);

            if (!response.ok) {
                throw new Error(data.error?.message || `API error: ${response.status}`);
            }

            if (data.error) {
                throw new Error(data.error.message || 'Unknown API error');
            }

            const assistantMessage = data.content[0].text;
            conversationHistory.push({ role: 'assistant', content: assistantMessage });

            return assistantMessage;
        }

        // ============================================
        // RESULTS DISPLAY
        // ============================================
        function displayResults(response) {
            const container = document.getElementById('results-content');
            
            // Parse markdown-style headers and format
            const sections = parseResponseSections(response);
            
            container.innerHTML = sections.map(section => `
                <div class="results-section">
                    <div class="results-section-header">
                        <div class="results-section-icon">${section.icon}</div>
                        <h3>${section.title}</h3>
                    </div>
                    <div class="results-content">${formatContent(section.content)}</div>
                </div>
            `).join('');
        }

        function parseResponseSections(response) {
            const sectionPatterns = [
                { pattern: /##\s*üîç\s*What.s Really Happening/i, icon: 'üîç', title: "What's Really Happening" },
                { pattern: /##\s*üéØ\s*How to Frame/i, icon: 'üéØ', title: 'How to Frame This' },
                { pattern: /##\s*üí¨\s*Language to Use/i, icon: 'üí¨', title: 'Language to Use (and Avoid)' },
                { pattern: /##\s*‚û°Ô∏è\s*Your Next/i, icon: '‚û°Ô∏è', title: 'Your Next Steps' },
                { pattern: /##\s*‚ö†Ô∏è\s*Watch Out/i, icon: '‚ö†Ô∏è', title: 'Watch Out For' }
            ];

            const sections = [];
            let remaining = response;

            sectionPatterns.forEach((sp, index) => {
                const match = remaining.match(sp.pattern);
                if (match) {
                    const startIndex = match.index + match[0].length;
                    let endIndex = remaining.length;

                    // Find next section
                    for (let i = index + 1; i < sectionPatterns.length; i++) {
                        const nextMatch = remaining.match(sectionPatterns[i].pattern);
                        if (nextMatch) {
                            endIndex = nextMatch.index;
                            break;
                        }
                    }

                    sections.push({
                        icon: sp.icon,
                        title: sp.title,
                        content: remaining.slice(startIndex, endIndex).trim()
                    });
                }
            });

            // If no sections found, return as single block
            if (sections.length === 0) {
                sections.push({
                    icon: 'üìã',
                    title: 'Your Action Plan',
                    content: response
                });
            }

            return sections;
        }

        function formatContent(content) {
            // Convert markdown-style formatting to HTML
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph if not already
            if (!html.startsWith('<')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }

        // ============================================
        // CHAT REFINEMENT
        // ============================================
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to UI
            addChatMessage(message, 'user');
            input.value = '';

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message bot';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = '<em>Thinking...</em>';
            document.getElementById('chat-messages').appendChild(typingDiv);

            try {
                const response = await callClaudeAPI(message);
                
                // Remove typing indicator
                const typing = document.getElementById('typing');
                if (typing) typing.remove();
                
                // Add response
                addChatMessage(response, 'bot');

            } catch (error) {
                const typing = document.getElementById('typing');
                if (typing) typing.remove();
                addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        }

        function addChatMessage(content, type) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message ${type}`;
            div.innerHTML = formatContent(content);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
